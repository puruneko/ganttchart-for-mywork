# 協業ポリシー（COOPERATION POLICY）

このドキュメントは、本プロジェクトにおける**AI開発者が絶対に順守すべきルール**を定義します。  
人間開発者からAI開発者への強い要望事項をまとめたものです。

---

## 1. 基本方針

### 1.1 言語とコミュニケーション
- **コメントおよび説明文は日本語で記述すること**
- コードの変数名・関数名は英語でOK
- commitメッセージは日本語を推奨

### 1.2 自律的な開発
- **スクリプト実行については事前の許可は不要**
- テストを実行するかどうか確認してはならない。必ず実行すること
- 実装中の細かい進捗レスポンスは不要  
  → **ある程度進んだ段階でまとめて報告すること**

### 1.3 指示の完遂
- **プロンプトの指示はすべて完了させること**
- 未完了で「どうしますか？」「テストは実行しますか？」などは絶対に尋ねないこと
- 完遂不可で無限ループに入る場合のみ、事象と問題点を明記したうえで指示を仰ぐこと

---

## 2. プロジェクト引き継ぎルール

### 2.1 必ず確認すべき情報源
開発プロジェクトの引き継ぎ情報は、以下を必ず確認すること：

1. **gitのcommitメッセージ**
   - `git log --oneline -30` で最近の変更を把握
   - commitメッセージを追うだけで開発の流れが理解できるように書かれている

2. **documents配下のMarkdownファイル**
   - `COOPERATION_POLICY.md` (本ファイル) - 開発ルール
   - `ONBOARDING.md` - 引き継ぎ情報と現在の状態
   - `ARCHITECTURE.md` - 技術的なアーキテクチャ説明
   - `LIBRARY_USAGE.md` - ライブラリ利用者向けドキュメント

### 2.2 ONBOARDING.mdの必須確認
- **ONBOARDING.mdは必須確認**
- 記載されている**引き継ぎチェックリストをすべて完了**させること
- 現在の開発状況と今後のポイントを把握すること

---

## 3. git運用ルール

### 3.1 コミット頻度
- **ファイル修正ごとに必ずcommitを行う**
- 大きな変更は複数のcommitに分割すること

### 3.2 コミットメッセージの品質
- commitメッセージを追うだけで、第三者が開発を引き継げるレベルを維持すること
- フォーマット：
  ```
  feat: 機能追加の説明
  fix: バグ修正の説明
  refactor: リファクタリングの説明
  test: テスト追加・修正の説明
  docs: ドキュメント更新の説明
  ```

---

## 4. コード変更とテストの必須条件

### 4.1 テスト実行の絶対ルール
- コード変更を行う場合、**必ず全テストがパスした状態で提出すること**
- テストを行うかどうかの確認は厳禁。**必ずテストを実行すること**
- 以下を満たすまで作業は完了とみなさない：
  - ✅ 全単体テストがパス (`npm test`)
  - ✅ 全E2Eテストがパス (`npm run test:e2e`)
   - `--reporter=list`, `--max-failures=1`, `--headed`などのオプションを**勝手に追加しない**
   - ` | Select-Object -First N`などでエラー出力を**絶対に切り詰めない**

### 4.2 テスト実施の基本ルール
- テスト失敗を減らすため、**テスト実行前に影響範囲を事前確認する**
- **すべてのテストがパスするまで作業を完了としない**
- テストが失敗した場合は：
  1. 必ず**原因を特定**
  2. 修正を行い、再度すべてのテストを実行すること
- テストコードは**tests配下**に作成する

### 4.3 テストが失敗する場合の対処
1. **既存の失敗**: 引き継ぎ時点で既に失敗している場合は、その旨を報告
2. **新規の失敗**: 自分の変更で発生した失敗は必ず修正すること
3. **修正できない失敗**: 原因を特定し、詳細を報告すること

### 4.4 ブラウザでの動作確認（重要度★★★）

**UI/UX関連の変更は、E2Eテストのパスだけでなく、必ずブラウザで実際の動作を確認すること**

#### 必須確認が必要な変更
以下の変更を行った場合は、**必ずブラウザで動作確認**すること：
- レイアウト変更（パネル配置、サイズ、余白等）
- インタラクション（クリック、ドラッグ、ズーム、スクロール等）
- **リアルタイム更新**（ハイライト、表示切り替え、同期処理等）
- 視覚的なフィードバック（色、アニメーション、トランジション等）
- CSS変更（スタイル、クラス、テーマ等）

#### 確認手順（必須）
1. **開発サーバーを起動**: `npm run dev`
2. **ブラウザで実際に操作**して動作確認
3. **ブラウザのコンソール（F12）を開いてエラーがないか確認**
4. **指示された機能が完全に動作するか確認**
   - 例: 「リアルタイムにハイライトが更新される」→ ズームを変えて実際にハイライトが移動するか確認
5. 問題があれば修正して再確認
6. **完全に動作することを確認してからコミット**

#### 禁止事項（絶対にやってはいけない）
- ❌ ブラウザ確認をスキップしてコミットすること
- ❌ **コンソールエラーを確認せずにコミットすること**
- ❌ E2Eテストがパスしたから動作すると推測すること
- ❌ 「ブラウザで確認してください」と人間に丸投げすること
- ❌ 「動作するはずです」と推測で報告すること

#### 理由
E2Eテストは基本的な動作を確認するものであり、視覚的な振る舞いやリアルタイム性を完全には検証できません。  
**実際にブラウザで確認しなければ、指示された機能が正しく実装されているか判断できません。**

---

## 5. UIテスト（Playwright / E2E）

### 5.1 テストフレームワーク
- UIテストは**PlaywrightによるE2Eテストのみ許可**
  - 配置先：`tests/e2e`
  - 実行コマンド：`npm run test:e2e`

### 5.2 テスト実行時の厳格なルール（重要度★★★）

#### ⚠️ コマンドの改変禁止
1. **ユーザーが指定したテストコマンドを一切改変せずに実行すること**
   - 例: ユーザーが`npm run test:e2e`と指定した場合、それ以外のコマンドを実行しない
   - `--reporter=list`, `--max-failures=1`, `--headed`などのオプションを**勝手に追加しない**
   - ` | Select-Object -First N`などでエラー出力を**絶対に切り詰めない**

2. **エラー出力の完全確認**
   - テスト結果の**全文を必ず確認**すること
   - 出力が長い場合でも、省略せず全文を読むこと
   - どうしても長い場合は、複数回に分けて全文を確認する

3. **エラーメッセージの優先順位**
   - **最初に表示されるエラーが真の問題である可能性が最も高い**
   - `Page error:`や`console.error`を最優先で確認する
   - HMRエラーや副次的なエラーに惑わされない
   - 例: HMRエラーの前に`DateTime is not defined`があれば、それが根本原因

4. **問題の本質を見極める**
   - 表面的なエラー（HMR、タイムアウトなど）ではなく、根本原因を特定する
   - エラーログの**最初の数行**に本質的な問題が記載されていることが多い
   - 「何が原因でそのエラーが発生したか」を必ず追跡する

#### ❌ 絶対にやってはいけないこと
- テストコマンドに勝手にオプションを追加すること
- `Select-Object -First N`でエラー出力を切り詰めること
- 最初のエラーメッセージを読まずに、後続のエラーだけを見ること
- 「おそらく〇〇が原因」と推測で判断すること
- エラーログの一部だけを見て全体を把握した気になること

### 5.3 Playwright実行ルール（重要）

#### サーバ起動
- 開発サーバの起動は**PlaywrightのwebServer設定に完全に任せる**
  - `npm run dev`を手動で起動してはならない
  - 開発ポートは**5176**
- **サーバが起動している前提でテストを書かない**

#### テストコード記述
- `baseURL`は**playwright.config.tsの設定のみを使用**
- `page.goto()`で以下を行うことは禁止：
  - `localhost`の直接指定
  - ポート番号の直接指定
  - `waitUntil`に`networkidle`の指定は禁止。`domcontentloaded`を推奨

#### トラブルシューティング
- サーバ起動失敗・ポート競合が発生した場合：
  - **テストコードは修正しない**
  - 起動方法や設定を見直すこと
- テスト終了後は**使用したポートを必ず解放する**

### 5.3 UIテスト内容の制約
- **ユーザー操作を伴わないUIテストは禁止**
- UIテストは最低限、以下をカバーすること：
  - 画面が表示されること
  - 主要操作（クリック・入力など）
  - 期待する結果が**DOMに反映されること**

---

## 6. クレジット消費に関する方針

### 6.1 効率的な開発
- **rovodevのクレジット消費を最小限に抑えること**
- テスト失敗 → 修正の回数は、可能な限り少なくする
- 検証や試行錯誤は、可能な限り内部で完結させること

### 6.2 コミュニケーション効率
- 私へのレスポンスは必要最低限とする
- 進捗報告は「〇〇を完了しました」の形式で簡潔に
- 質問は本当に必要な場合のみ

---

## 7. フェーズ制約

### 7.1 理解フェーズ
本ポリシーの理解のみを求められた場合：
- **理解のみを行い、開発を開始しないこと**
- 以下の質問に**はい/いいえで回答すること**：
  1. COOPERATION_POLICY.mdの内容を理解しましたか？
  2. 単体テスト、UIテストの両方をパスするまで作業完了ではないことを理解しましたか？
  3. ONBOARDING.mdの「開発の引き継ぎチェックリスト」をすべてパスしましたか？

---

## 8. 絶対に守るべきこと（重要度★★★）

### ❌ やってはいけないこと
1. テスト実行を省略すること
2. テストが失敗したまま作業完了とすること
3. 「テストを実行しますか？」と確認すること
4. commitせずに大量の変更を行うこと
5. 手動で開発サーバーを起動してE2Eテストを実行すること
6. **UI/UX変更でブラウザ確認をスキップすること**
7. **「確認してください」と人間に動作確認を丸投げすること**

### ✅ 必ずやること
1. コード変更後は必ず全テストを実行
2. テストが失敗したら必ず修正
3. ファイル修正ごとにcommit
4. ONBOARDING.mdで現在の状況を確認
5. documents配下のドキュメントを参照
6. **UI/UX変更後はブラウザで実際の動作を確認**

---

## 9. まとめ

このポリシーは、**効率的で高品質な開発**を実現するための最低限のルールです。  
AI開発者は、これらのルールを絶対に順守してください。

**最も重要なこと：**
- テストは必ず実行し、すべてパスさせること
- **UI/UX変更はブラウザで実際の動作を確認すること**
- 確認せずに自律的に開発を進めること
- commitを細かく行い、引き継ぎ可能な状態を維持すること
